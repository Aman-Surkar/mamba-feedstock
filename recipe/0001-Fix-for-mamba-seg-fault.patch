From 8c3d11b2c86ff417307c9678bc2f222ed791140b Mon Sep 17 00:00:00 2001
From: Aman-Surkar <aman_surkar@persistent.com>
Date: Mon, 25 Sep 2023 18:14:01 +0000
Subject: [PATCH] Fix for mamba seg fault

---
 libmamba/src/core/url.cpp | 18 +++++++++++-------
 1 file changed, 11 insertions(+), 7 deletions(-)

diff --git a/libmamba/src/core/url.cpp b/libmamba/src/core/url.cpp
index 23f6255c..54c64b3a 100644
--- a/libmamba/src/core/url.cpp
+++ b/libmamba/src/core/url.cpp
@@ -168,16 +168,20 @@ namespace mamba
             u = u.substr(0, u.size() - 13);
         }
 
-        unsigned char hash[16];
-
-        EVP_MD_CTX* mdctx;
-        mdctx = EVP_MD_CTX_create();
-        EVP_DigestInit_ex(mdctx, EVP_md5(), nullptr);
+        const EVP_MD* type = EVP_md5();
+        unsigned char hash[EVP_MAX_MD_SIZE];
+        if (FIPS_mode())
+        {
+            type = EVP_sha256();
+        }
+        unsigned int mdLen = 0;
+        EVP_MD_CTX *mdctx = EVP_MD_CTX_new();
+        EVP_DigestInit_ex(mdctx, type, nullptr);
         EVP_DigestUpdate(mdctx, u.c_str(), u.size());
-        EVP_DigestFinal_ex(mdctx, hash, nullptr);
+        EVP_DigestFinal_ex(mdctx, hash, &mdLen);
         EVP_MD_CTX_destroy(mdctx);
 
-        std::string hex_digest = hex_string(hash, 16);
+        std::string hex_digest = hex_string(hash, mdLen);
         return hex_digest.substr(0u, 8u);
     }
 
-- 
2.40.1

